"use strict";var __awaiter=this&&this.__awaiter||function(t,e,i,s){return new(i||(i=Promise))(function(n,r){function o(t){try{h(s.next(t))}catch(t){r(t)}}function a(t){try{h(s.throw(t))}catch(t){r(t)}}function h(t){t.done?n(t.value):new i(function(e){e(t.value)}).then(o,a)}h((s=s.apply(t,e||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const log_1=require("../extra/log"),keyboard_1=require("./keyboard");class Context{constructor(t,e,i,s){this.autoSend=!0,this.api=t,this.obj=i,this.msg=s,this.eventType=e,this.clear()}clear(){this.replyText="",this.attachment=[],this.kbdObject="",this.pid=this.getOriginalPid()}noAutoSend(){this.autoSend=!1}needsAutoSend(){return this.autoSend}getPid(){return this.pid}setPid(t){this.pid=t.toString()}getOriginalPid(){let t=this.eventType,e=this.obj;return"message_allow"===t?e.user_id:"message_typing_state"===t?e.from_id:e.peer_id}text(t){this.replyText=t}attach(t,e,i,s){s?this.attachment.push(`${t}${e}_${i}_${s}`):this.attachment.push(`${t}${e}_${i}`)}keyboard(t){this.kbdObject=JSON.stringify(t)}removeKeyboard(){this.keyboard(new keyboard_1.Keyboard)}send(){return __awaiter(this,void 0,void 0,function*(){if("message_deny"===this.eventType)return void log_1.log().w(`No message was sent to peer ${this.pid} ("message_deny" event)`).from("ctx").now();if(""===this.replyText&&this.attachment===[])return void log_1.log().w(`No message was sent to peer ${this.pid} (text or attachment is required)`).from("ctx").now();const t=this.attachment.join(",");return this.api.send(this.pid,this.replyText,t,this.kbdObject)})}}exports.default=Context;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwaS9jb250ZXh0LmpzIiwiYXBpL2NvbnRleHQudHMiXSwibmFtZXMiOlsiX19hd2FpdGVyIiwidGhpcyIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJsb2dfMSIsInJlcXVpcmUiLCJrZXlib2FyZF8xIiwiQ29udGV4dCIsIltvYmplY3QgT2JqZWN0XSIsImFwaSIsImV2ZW50VHlwZSIsIm9iamVjdCIsIm1lc3NhZ2UiLCJhdXRvU2VuZCIsIm9iaiIsIm1zZyIsImNsZWFyIiwicmVwbHlUZXh0IiwiYXR0YWNobWVudCIsImtiZE9iamVjdCIsInBpZCIsImdldE9yaWdpbmFsUGlkIiwidG9TdHJpbmciLCJ1c2VyX2lkIiwiZnJvbV9pZCIsInBlZXJfaWQiLCJ0eHQiLCJ0eXBlIiwib3duZXJJZCIsInJlc0lkIiwiYWNjZXNzS2V5IiwicHVzaCIsImtiZCIsIkpTT04iLCJzdHJpbmdpZnkiLCJrZXlib2FyZCIsIktleWJvYXJkIiwibG9nIiwidyIsImZyb20iLCJub3ciLCJhdHRhY2htZW50TGlzdCIsImpvaW4iLCJzZW5kIiwiZGVmYXVsdCJdLCJtYXBwaW5ncyI6IkFBQUEsYUFDQSxJQUFJQSxVQUFhQyxNQUFRQSxLQUFLRCxXQUFjLFNBQVVFLEVBQVNDLEVBQVlDLEVBQUdDLEdBQzFFLE9BQU8sSUFBS0QsSUFBTUEsRUFBSUUsVUFBVSxTQUFVQyxFQUFTQyxHQUMvQyxTQUFTQyxFQUFVQyxHQUFTLElBQU1DLEVBQUtOLEVBQVVPLEtBQUtGLElBQVcsTUFBT0csR0FBS0wsRUFBT0ssSUFDcEYsU0FBU0MsRUFBU0osR0FBUyxJQUFNQyxFQUFLTixFQUFpQixNQUFFSyxJQUFXLE1BQU9HLEdBQUtMLEVBQU9LLElBQ3ZGLFNBQVNGLEVBQUtJLEdBQVVBLEVBQU9DLEtBQU9ULEVBQVFRLEVBQU9MLE9BQVMsSUFBSU4sRUFBRSxTQUFVRyxHQUFXQSxFQUFRUSxFQUFPTCxTQUFXTyxLQUFLUixFQUFXSyxHQUNuSUgsR0FBTU4sRUFBWUEsRUFBVWEsTUFBTWhCLEVBQVNDLEdBQWMsS0FBS1MsV0FHdEVPLE9BQU9DLGVBQWVDLFFBQVMsYUFBYyxDQUFFWCxPQUFPLElDVHRELE1BQUFZLE1BQUFDLFFBQUEsZ0JBRUFDLFdBQUFELFFBQUEsY0FLQSxNQUFxQkUsUUE4RGpCQyxZQUFtQkMsRUFBVUMsRUFBbUJDLEVBQWdCQyxHQS9CeEQ3QixLQUFBOEIsVUFBb0IsRUFnQ3hCOUIsS0FBSzBCLElBQU1BLEVBQ1gxQixLQUFLK0IsSUFBTUgsRUFDWDVCLEtBQUtnQyxJQUFNSCxFQUNYN0IsS0FBSzJCLFVBQVlBLEVBQ2pCM0IsS0FBS2lDLFFBUUZSLFFBQ0h6QixLQUFLa0MsVUFBWSxHQUNqQmxDLEtBQUttQyxXQUFhLEdBQ2xCbkMsS0FBS29DLFVBQVksR0FDakJwQyxLQUFLcUMsSUFBTXJDLEtBQUtzQyxpQkFNYmIsYUFDSHpCLEtBQUs4QixVQUFXLEVBTWJMLGdCQUNILE9BQU96QixLQUFLOEIsU0FNVEwsU0FDSCxPQUFPekIsS0FBS3FDLElBUVRaLE9BQU9ZLEdBQ1ZyQyxLQUFLcUMsSUFBTUEsRUFBSUUsV0FNWmQsaUJBQ0gsSUFBSUUsRUFBWTNCLEtBQUsyQixVQUNqQkksRUFBTS9CLEtBQUsrQixJQUVmLE1BQWtCLGtCQUFkSixFQUNPSSxFQUFJUyxRQUNVLHlCQUFkYixFQUNBSSxFQUFJVSxRQUVKVixFQUFJVyxRQVNaakIsS0FBS2tCLEdBQ1IzQyxLQUFLa0MsVUFBWVMsRUFlZGxCLE9BQ0htQixFQUNBQyxFQUNBQyxFQUNBQyxHQUVJQSxFQUNBL0MsS0FBS21DLFdBQVdhLFFBQVFKLElBQU9DLEtBQVdDLEtBQVNDLEtBRW5EL0MsS0FBS21DLFdBQVdhLFFBQVFKLElBQU9DLEtBQVdDLEtBaUMzQ3JCLFNBQVN3QixHQUNaakQsS0FBS29DLFVBQVljLEtBQUtDLFVBQVVGLEdBTTdCeEIsaUJBQ0h6QixLQUFLb0QsU0FBUyxJQUFJN0IsV0FBQThCLFVBUVQ1QixPRGhKVCxPQUFPMUIsVUFBVUMsVUFBTSxPQUFRLEVBQVEsWUNpSnZDLEdBQXVCLGlCQUFuQkEsS0FBSzJCLFVBS0wsWUFKQU4sTUFBQWlDLE1BQ0tDLGlDQUFpQ3ZELEtBQUtxQyw4QkFDdENtQixLQUFLLE9BQ0xDLE1BSVQsR0FBdUIsS0FBbkJ6RCxLQUFLa0MsV0FBb0JsQyxLQUFLbUMsYUFBZSxHQUs3QyxZQUpBZCxNQUFBaUMsTUFDS0MsaUNBQWlDdkQsS0FBS3FDLHdDQUN0Q21CLEtBQUssT0FDTEMsTUFJVCxNQUFNQyxFQUFpQjFELEtBQUttQyxXQUFXd0IsS0FBSyxLQUc1QyxPQUFPM0QsS0FBSzBCLElBQUlrQyxLQUNaNUQsS0FBS3FDLElBQ0xyQyxLQUFLa0MsVUFDTHdCLEVBQ0ExRCxLQUFLb0MsY0F2T2pCaEIsUUFBQXlDLFFBQUFyQyIsImZpbGUiOiJhcGkvY29udGV4dC5qcyIsInNvdXJjZXNDb250ZW50IjpbbnVsbCwiaW1wb3J0IHsgbG9nIH0gZnJvbSAnLi4vZXh0cmEvbG9nJztcbmltcG9ydCBBUEkgZnJvbSAnLi9hcGknO1xuaW1wb3J0IHsgS2V5Ym9hcmQgfSBmcm9tICcuL2tleWJvYXJkJztcblxuLyoqXG4gKiBDb250ZXh0LCB3aGljaCBpcyBwYXNzZWQgdG8gZXZlcnkgaGFuZGxlci5cbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ29udGV4dCB7XG4gICAgLyoqXG4gICAgICogQVBJLlxuICAgICAqL1xuICAgIHB1YmxpYyByZWFkb25seSBhcGk6IEFQSTtcblxuICAgIC8qKlxuICAgICAqIEZ1bGwgb2JqZWN0IHBhc3NlZCBieSBDYWxsYmFjayBBUEkuXG4gICAgICpcbiAgICAgKiAqKk5vdGU6KiogSWYgYG1lc3NhZ2VfbmV3YCwgYG1lc3NhZ2VfcmVwbHlgLCBgbWVzc2FnZV9lZGl0YCBvciBgbm9fbWF0Y2hgIGV2ZW50LFxuICAgICAqIHRoaXMgaXMgYSBbUHJpdmF0ZSBtZXNzYWdlIG9iamVjdF0oaHR0cHM6Ly92ay5jb20vZGV2L29iamVjdHMvbWVzc2FnZSkuXG4gICAgICogRWxzZSwgc2VlIFtDYWxsYmFjayBBUEkgZG9jc10oaHR0cHM6Ly92ay5jb20vZGV2L2NhbGxiYWNrX2FwaSkgb3JcbiAgICAgKiBbR3JvdXBzIEV2ZW50cyBkb2NzXShodHRwczovL3ZrLmNvbS9kZXYvZ3JvdXBzX2V2ZW50cykgZm9yIG1vcmUgaW5mb3JtYXRpb24uXG4gICAgICovXG4gICAgcHVibGljIHJlYWRvbmx5IG9iajogYW55OyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcblxuICAgIC8qKlxuICAgICAqIEluY29taW5nIHVzZXIgbWVzc2FnZS5cbiAgICAgKlxuICAgICAqICoqTm90ZToqKiBJZiBbW0NvcmUuY21kXV0gaGFuZGxlciwgY29udGFpbnMgbWVzc2FnZSB3aXRob3V0IGBjbWRfcHJlZml4YCBhbmQgdGhlIGNvbW1hbmRcbiAgICAgKi9cbiAgICBwdWJsaWMgbXNnOiBzdHJpbmc7IC8vIFRPRE86IFNob3VsZCBiZSByZWFkb25seVxuXG4gICAgLyoqXG4gICAgICogTmFtZSBvZiB0aGUgZXZlbnQuXG4gICAgICovXG4gICAgcHVibGljIHJlYWRvbmx5IGV2ZW50VHlwZTogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogRG9lcyB0aGlzIFtbQ29udGV4dF1dJ3MgcmVzcG9uc2UgbmVlZCBhdXRvLXNlbmRpbmc/XG4gICAgICovXG4gICAgcHJpdmF0ZSBhdXRvU2VuZDogYm9vbGVhbiA9IHRydWU7XG5cbiAgICAvKipcbiAgICAgKiBUaGUgSUQgb2YgYSBwZWVyLCB0byB3aGljaCB0aGUgcmVwbHkgaXMgZ29pbmcgdG8gYmUgc2VudFxuICAgICAqXG4gICAgICogKipOb3RlOioqIFlvdSBjYW4gY2hhbmdlIHRoaXMgdXNpbmcgW1tzZXRQaWRdXSBtZXRob2QsXG4gICAgICogdGhlIG9yaWdpbmFsIFBlZXIgSUQgY2FuIGJlIG9idGFpbmVkIHVzaW5nIFtbZ2V0T3JpZ2luYWxQaWRdXS5cbiAgICAgKi9cbiAgICBwcml2YXRlIHBpZDogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogVGV4dCwgd2hpY2ggd2lsbCBiZSB1c2VkIGluIHRoZSByZXBseVxuICAgICAqL1xuICAgIHByaXZhdGUgcmVwbHlUZXh0OiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBBdHRhY2htZW50cywgd2hpY2ggd2lsbCBiZSB1c2VkIGluIHRoZSByZXBseVxuICAgICAqL1xuICAgIHByaXZhdGUgYXR0YWNobWVudDogc3RyaW5nW107XG5cbiAgICAvKipcbiAgICAgKiBPYmplY3Qgb2YgdGhlIFtbS2V5Ym9hcmRdXSwgd2hpY2ggd2lsbCBiZSB1c2VkIGluIHRoZSByZXBseVxuICAgICAqL1xuICAgIHByaXZhdGUga2JkT2JqZWN0OiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0gYXBpIHRoZSBBUEkgb2JqZWN0XG4gICAgICogQHBhcmFtIGV2ZW50VHlwZSB0aGUgZXZlbnQgdHlwZVxuICAgICAqIEBwYXJhbSBvYmplY3QgZnVsbCBvYmplY3QgZnJvbSBDYWxsYmFjayBBUElcbiAgICAgKiBAcGFyYW0gbWVzc2FnZSB0aGUgbWVzc2FnZVxuICAgICAqL1xuICAgIHB1YmxpYyBjb25zdHJ1Y3RvcihhcGk6IEFQSSwgZXZlbnRUeXBlOiBzdHJpbmcsIG9iamVjdDogb2JqZWN0LCBtZXNzYWdlOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5hcGkgPSBhcGk7XG4gICAgICAgIHRoaXMub2JqID0gb2JqZWN0O1xuICAgICAgICB0aGlzLm1zZyA9IG1lc3NhZ2U7XG4gICAgICAgIHRoaXMuZXZlbnRUeXBlID0gZXZlbnRUeXBlO1xuICAgICAgICB0aGlzLmNsZWFyKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2xlYXJzIHRoZSBidWZmZXIgYW5kIHJlc2V0cyB0aGUgUGVlciBJRCBiYWNrIHRvIG9yaWdpbmFsLlxuICAgICAqIFxuICAgICAqIEZvciBleGFtcGxlLCBhZnRlciBjYWxsaW5nIHRoaXMgeW91IGNhbiBjb21wb3NlIGFub3RoZXIgbWVzc2FnZSB0byB0aGUgc2FtZSB1c2VyLlxuICAgICAqL1xuICAgIHB1YmxpYyBjbGVhcigpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5yZXBseVRleHQgPSAnJztcbiAgICAgICAgdGhpcy5hdHRhY2htZW50ID0gW107XG4gICAgICAgIHRoaXMua2JkT2JqZWN0ID0gJyc7XG4gICAgICAgIHRoaXMucGlkID0gdGhpcy5nZXRPcmlnaW5hbFBpZCgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFByZXZlbnRzIHRoaXMgaGFuZGxlciBmcm9tIHNlbmRpbmcgdGhlIG1lc3NhZ2UgYXV0b21hdGljYWxseSBhZnRlciBpdCBmaW5pc2hlcy5cbiAgICAgKi9cbiAgICBwdWJsaWMgbm9BdXRvU2VuZCgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5hdXRvU2VuZCA9IGZhbHNlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIERvZXMgdGhpcyBbW0NvbnRleHRdXSdzIHJlc3BvbnNlIG5lZWQgYXV0by1zZW5kaW5nP1xuICAgICAqL1xuICAgIHB1YmxpYyBuZWVkc0F1dG9TZW5kKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5hdXRvU2VuZDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm5zIHRoZSBjdXJyZW50IHBlZXIgSUQuXG4gICAgICovXG4gICAgcHVibGljIGdldFBpZCgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5waWQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2V0cyBhIG5ldyBwZWVyIElELlxuICAgICAqXG4gICAgICogQHBhcmFtIHBpZCBuZXcgcGVlciBJRFxuICAgICAqL1xuICAgIHB1YmxpYyBzZXRQaWQocGlkOiBzdHJpbmcgfCBudW1iZXIpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5waWQgPSBwaWQudG9TdHJpbmcoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm5zIHRoZSBvcmlnaW5hbCBwZWVyIElEIGZyb20gdGhlIENhbGxiYWNrIEFQSSBvYmplY3QuXG4gICAgICovXG4gICAgcHVibGljIGdldE9yaWdpbmFsUGlkKCk6IHN0cmluZyB7XG4gICAgICAgIGxldCBldmVudFR5cGUgPSB0aGlzLmV2ZW50VHlwZTtcbiAgICAgICAgbGV0IG9iaiA9IHRoaXMub2JqO1xuXG4gICAgICAgIGlmIChldmVudFR5cGUgPT09ICdtZXNzYWdlX2FsbG93Jykge1xuICAgICAgICAgICAgcmV0dXJuIG9iai51c2VyX2lkO1xuICAgICAgICB9IGVsc2UgaWYgKGV2ZW50VHlwZSA9PT0gJ21lc3NhZ2VfdHlwaW5nX3N0YXRlJykge1xuICAgICAgICAgICAgcmV0dXJuIG9iai5mcm9tX2lkO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIG9iai5wZWVyX2lkO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2V0cyB0aGUgcmVwbHkgbWVzc2FnZSB0ZXh0LlxuICAgICAqXG4gICAgICogQHBhcmFtIHR4dCBuZXcgdGV4dFxuICAgICAqL1xuICAgIHB1YmxpYyB0ZXh0KHR4dDogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIHRoaXMucmVwbHlUZXh0ID0gdHh0O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZHMgYW4gYXR0YWNobWVudCB0byB0aGUgbWVzc2FnZS5cbiAgICAgKlxuICAgICAqICoqTm90ZToqKiBNb3JlIGluZm9ybWF0aW9uIG9uIHRoZSBwYXJhbWV0ZXJzIGNhbiBiZSBmb3VuZCBpblxuICAgICAqIFtWSyBBUEkgZG9jc10oaHR0cHM6Ly92ay5jb20vZGV2L21lc3NhZ2VzLnNlbmQpLlxuICAgICAqXG4gICAgICogQHBhcmFtIHR5cGUgdGhlIHR5cGUgb2YgYXR0YWNobWVudFxuICAgICAqIEBwYXJhbSBvd25lcklkIHJlc291cmNlIG93bmVyIElEXG4gICAgICogQHBhcmFtIHJlc0lkIHJlc291cmNlIElEXG4gICAgICogQHBhcmFtIGFjY2Vzc0tleSByZXNvdXJjZSBhY2Nlc3Mga2V5LCBpZiBuZWVkZWQ7XG4gICAgICogc2VlIFtBY2Nlc3MgS2V5XShodHRwczovL3ZrLmNvbS9kZXYvYWNjZXNzX2tleSkgcGFnZSBpbiBBUEkgZG9jcyBmb3IgbW9yZSBpbmZvcm1hdGlvblxuICAgICAqL1xuICAgIHB1YmxpYyBhdHRhY2goXG4gICAgICAgIHR5cGU6IHN0cmluZyxcbiAgICAgICAgb3duZXJJZDogc3RyaW5nIHwgbnVtYmVyLFxuICAgICAgICByZXNJZDogc3RyaW5nIHwgbnVtYmVyLFxuICAgICAgICBhY2Nlc3NLZXk/OiBzdHJpbmcsXG4gICAgKTogdm9pZCB7XG4gICAgICAgIGlmIChhY2Nlc3NLZXkpIHtcbiAgICAgICAgICAgIHRoaXMuYXR0YWNobWVudC5wdXNoKGAke3R5cGV9JHtvd25lcklkfV8ke3Jlc0lkfV8ke2FjY2Vzc0tleX1gKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuYXR0YWNobWVudC5wdXNoKGAke3R5cGV9JHtvd25lcklkfV8ke3Jlc0lkfWApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQXR0YWNoZXMgYSBrZXlib2FyZC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSBrYmQgdGhlIGtleWJvYXJkXG4gICAgICpcbiAgICAgKiBAZXhhbXBsZVxuICAgICAqIGBgYFxuICAgICAqIGNvbnN0IHsgQ29sb3IsIEtleWJvYXJkLCBidXR0b24gfSA9IHZrLmtiZDtcbiAgICAgKlxuICAgICAqIGNvcmUuY21kKCdrZXlib2FyZCcsICQgPT4ge1xuICAgICAqICAgICAvLyBTZXQgJ3RydWUnIGluc3RlYWQgb2YgJ2ZhbHNlJyB0byBtYWtlIGl0IGRpc2FwcGVhciBhZnRlciBhIGJ1dHRvbiB3YXMgcHJlc3NlZFxuICAgICAqICAgICB2YXIga2JkID0gbmV3IEtleWJvYXJkKFtcbiAgICAgKiAgICAgICAgIC8vIFJvd3NcbiAgICAgKiAgICAgICAgIFtcbiAgICAgKiAgICAgICAgICAgICBidXR0b24udGV4dCgnRGVmYXVsdCcpLFxuICAgICAqICAgICAgICAgICAgIGJ1dHRvbi50ZXh0KCdQcmltYXJ5JywgQ29sb3IuUHJpbWFyeSksXG4gICAgICogICAgICAgICAgICAgYnV0dG9uLnRleHQoJ05lZ2F0aXZlJywgQ29sb3IuTmVnYXRpdmUpLFxuICAgICAqICAgICAgICAgICAgIGJ1dHRvbi50ZXh0KCdQb3NpdGl2ZScsIENvbG9yLlBvc2l0aXZlKVxuICAgICAqICAgICAgICAgXSxcbiAgICAgKiAgICAgICAgIFtcbiAgICAgKiAgICAgICAgICAgICBidXR0b24udGV4dCgnTWF4aW11bSByb3dzIGlzIDEwLCBjb2x1bW5zIC0gNC4nKVxuICAgICAqICAgICAgICAgXSxcbiAgICAgKiAgICBdLCBmYWxzZSk7XG4gICAgICpcbiAgICAgKiAgICAkLnRleHQoJ0hlcmUgaXMgeW91ciBrZXlib2FyZCwgYXMgcHJvbWlzZWQuJyk7XG4gICAgICogICAgJC5rZXlib2FyZChrYmQpO1xuICAgICAqIH0sICdkZW1vIGtleWJvYXJkJyk7XG4gICAgICogYGBgXG4gICAgICovXG4gICAgcHVibGljIGtleWJvYXJkKGtiZDogS2V5Ym9hcmQpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5rYmRPYmplY3QgPSBKU09OLnN0cmluZ2lmeShrYmQpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEF0dGFjaGVzIGFuIGVtcHR5IGtleWJvYXJkLlxuICAgICAqL1xuICAgIHB1YmxpYyByZW1vdmVLZXlib2FyZCgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5rZXlib2FyZChuZXcgS2V5Ym9hcmQoKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2VuZHMgdGhlIGNvbXBvc2VkIG1lc3NhZ2UgdG8gdXNlci5cbiAgICAgKiAqKk5vdGU6KiogQWZ0ZXIgdGhlIGhhbmRsZXIgZmluaXNoZXMgaXRzIHdvcmssIHRoaXMgbWV0aG9kIGlzIGNhbGxlZCBhdXRvbWF0aWNhbGx5XG4gICAgICogKGlmIFtbbm9BdXRvU2VuZF1dIHdhcyBub3QgY2FsbGVkKVxuICAgICAqL1xuICAgIHB1YmxpYyBhc3luYyBzZW5kKCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBpZiAodGhpcy5ldmVudFR5cGUgPT09ICdtZXNzYWdlX2RlbnknKSB7XG4gICAgICAgICAgICBsb2coKVxuICAgICAgICAgICAgICAgIC53KGBObyBtZXNzYWdlIHdhcyBzZW50IHRvIHBlZXIgJHt0aGlzLnBpZH0gKFwibWVzc2FnZV9kZW55XCIgZXZlbnQpYClcbiAgICAgICAgICAgICAgICAuZnJvbSgnY3R4JylcbiAgICAgICAgICAgICAgICAubm93KCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5yZXBseVRleHQgPT09ICcnICYmIHRoaXMuYXR0YWNobWVudCA9PT0gW10pIHtcbiAgICAgICAgICAgIGxvZygpXG4gICAgICAgICAgICAgICAgLncoYE5vIG1lc3NhZ2Ugd2FzIHNlbnQgdG8gcGVlciAke3RoaXMucGlkfSAodGV4dCBvciBhdHRhY2htZW50IGlzIHJlcXVpcmVkKWApXG4gICAgICAgICAgICAgICAgLmZyb20oJ2N0eCcpXG4gICAgICAgICAgICAgICAgLm5vdygpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgYXR0YWNobWVudExpc3QgPSB0aGlzLmF0dGFjaG1lbnQuam9pbignLCcpO1xuXG4gICAgICAgIC8qIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBjb25zaXN0ZW50LXJldHVybiAqL1xuICAgICAgICByZXR1cm4gdGhpcy5hcGkuc2VuZChcbiAgICAgICAgICAgIHRoaXMucGlkLFxuICAgICAgICAgICAgdGhpcy5yZXBseVRleHQsXG4gICAgICAgICAgICBhdHRhY2htZW50TGlzdCxcbiAgICAgICAgICAgIHRoaXMua2JkT2JqZWN0LFxuICAgICAgICApO1xuICAgIH1cbn1cbiJdfQ==
