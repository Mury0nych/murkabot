"use strict";var __awaiter=this&&this.__awaiter||function(e,t,s,r){return new(s||(s=Promise))(function(o,i){function n(e){try{a(r.next(e))}catch(e){i(e)}}function u(e){try{a(r.throw(e))}catch(e){i(e)}}function a(e){e.done?o(e.value):new s(function(t){t(e.value)}).then(n,u)}a((r=r.apply(e,t||[])).next())})},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const crypto_1=__importDefault(require("crypto")),request_promise_1=__importDefault(require("request-promise")),log_1=require("../extra/log"),API_VERSION="5.95",API_QUOTA=20;class API{constructor(e,t){this.queue=[],this.isQueueProcessing=!1,this.vkToken=e,this.stats=t,this.checkPermissions().then(e=>{log_1.log().i(e).from("api").now()}).catch(e=>{log_1.log().w(e).from("api").now()}),setInterval(()=>{this.isQueueProcessing||(this.isQueueProcessing=!0,this.processQueue().then(()=>{this.isQueueProcessing=!1}).catch(e=>{log_1.log().w(e).from("api").now(),this.isQueueProcessing=!1}))},1e3)}scheduleCall(e,t){return __awaiter(this,void 0,void 0,function*(){return new Promise((s,r)=>{this.queue.push({method:e,params:t,resolve:s,reject:r})})})}call(e,t){return __awaiter(this,void 0,void 0,function*(){const s={uri:`https://api.vk.com/method/${encodeURIComponent(e)}`,json:!0,qs:Object.assign({access_token:this.vkToken,v:API_VERSION},t)},r=request_promise_1.default(s);return r.catch(t=>{log_1.log().w(`Error occured while calling API method '${e}': ${t}`).from("api").now()}),r})}send(e,t,s,r){return __awaiter(this,void 0,void 0,function*(){const o={peer_id:e.toString(),random_id:BigInt.asIntN(32,BigInt(`0x${crypto_1.default.randomBytes(6).toString("hex")}`)).toString()};return t&&(o.message=t),s&&(o.attachment=s),r&&(o.keyboard=r),new Promise(e=>{this.scheduleCall("messages.send",o).then(()=>{this.stats.sent(),e()}).catch(t=>{log_1.log().w(t).from("api").now(),e()})})})}checkPermissions(){return __awaiter(this,void 0,void 0,function*(){const e=yield this.scheduleCall("groups.getTokenPermissions",{}),{permissions:t}=e;let s=!1;return t.forEach(e=>{"messages"===e.name&&(s=!0)}),s?Promise.resolve("Token permission `messages` is present"):Promise.reject(new Error("Token permission `messages` is missing. Bot will be unable to send any messages"))})}processQueue(){return __awaiter(this,void 0,void 0,function*(){if(this.queue){for(let e=1;e<=API_QUOTA&&0!==this.queue.length;e+=1){const e=this.queue.shift(),t=yield this.call(e.method,e.params);if(void 0!==t.response&&null!==t.response)e.resolve(t.response);else if(t.error){const s=t.error.error_code,r=t.error.error_msg;e.reject(`An API call to method '${e.method}' failed due to an API error #${s}: ${r}`)}else e.reject(`An API call to method '${e.method}' failed due to an unknown API error. The API responded with: ${JSON.stringify(t)}`)}return Promise.resolve()}return Promise.reject(new Error("No queue for API calls found"))})}}exports.default=API;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwaS9hcGkuanMiLCJhcGkvYXBpLnRzIl0sIm5hbWVzIjpbIl9fYXdhaXRlciIsInRoaXMiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiX19pbXBvcnREZWZhdWx0IiwibW9kIiwiX19lc01vZHVsZSIsImRlZmF1bHQiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJjcnlwdG9fMSIsInJlcXVpcmUiLCJyZXF1ZXN0X3Byb21pc2VfMSIsImxvZ18xIiwiQVBJX1ZFUlNJT04iLCJBUElfUVVPVEEiLCJBUEkiLCJbb2JqZWN0IE9iamVjdF0iLCJ2a1Rva2VuIiwic3RhdHMiLCJxdWV1ZSIsImlzUXVldWVQcm9jZXNzaW5nIiwiY2hlY2tQZXJtaXNzaW9ucyIsImxvZyIsImkiLCJmcm9tIiwibm93IiwiY2F0Y2giLCJ3Iiwic2V0SW50ZXJ2YWwiLCJwcm9jZXNzUXVldWUiLCJtZXRob2QiLCJwYXJhbXMiLCJwdXNoIiwib3B0aW9ucyIsInVyaSIsImVuY29kZVVSSUNvbXBvbmVudCIsImpzb24iLCJxcyIsImFzc2lnbiIsImFjY2Vzc190b2tlbiIsInYiLCJwcm9taXNlIiwiZXJyIiwicGlkIiwibWVzc2FnZSIsImF0dGFjaG1lbnQiLCJrZXlib2FyZCIsInBlZXJfaWQiLCJ0b1N0cmluZyIsInJhbmRvbV9pZCIsIkJpZ0ludCIsImFzSW50TiIsInJhbmRvbUJ5dGVzIiwic2NoZWR1bGVDYWxsIiwic2VudCIsInJlc3BvbnNlIiwicGVybWlzc2lvbnMiLCJvayIsImZvckVhY2giLCJwZXJtaXNzaW9uIiwibmFtZSIsIkVycm9yIiwibGVuZ3RoIiwic2hpZnQiLCJjYWxsIiwidW5kZWZpbmVkIiwiZXJyb3IiLCJlcnJv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SzlILE9BQU8vQyxRQUFRQyxVQUduQixPQUFPRCxRQUFRRSxPQUFPLElBQUlzRSxNQUFNLG9DQWhTeENyRCxRQUFBSCxRQUFBVSIsImZpbGUiOiJhcGkvYXBpLmpzIiwic291cmNlc0NvbnRlbnQiOltudWxsLCJpbXBvcnQgY3J5cHRvIGZyb20gJ2NyeXB0byc7XG5pbXBvcnQgcmVxdWVzdCBmcm9tICdyZXF1ZXN0LXByb21pc2UnO1xuaW1wb3J0IHsgbG9nIH0gZnJvbSAnLi4vZXh0cmEvbG9nJztcbmltcG9ydCBTdGF0cyBmcm9tICcuLi9leHRyYS9zdGF0cyc7XG5cbi8qKlxuICogVksgQVBJIHZlcnNpb24gdXNlZCBieSBBUEkuXG4gKi9cbmNvbnN0IEFQSV9WRVJTSU9OID0gJzUuOTUnO1xuLyoqXG4gKiBBUEkgcXVvdGEsIGluIHJlcXVlc3RzIHBlciBzZWNvbmRcbiAqL1xuY29uc3QgQVBJX1FVT1RBID0gMjA7XG5cbi8qKlxuICogVXNlZCB0byBjYWxsIEFQSSBtZXRob2RzLlxuICpcbiAqIFlvdSBjYW4gZ2V0IHRoZSBbW0FQSV1dIG9iamVjdCBmcm9tIGEgW1tDb250ZXh0XV0gb2JqZWN0OlxuICogYGBganNcbiAqIC8vIEFzc3VtaW5nIHlvdXIgQ29udGV4dCBvYmplY3QgaXMgJFxuICogdmFyIGFwaSA9ICQuYXBpXG4gKiBgYGBcbiAqXG4gKiBPciBmcm9tIFtbQ29yZV1dIChhZnRlciBpbml0aWFsaXphdGlvbiB3aXRoIFtbYm90XV06XG4gKiBgYGBqc1xuICogdmFyIGFwaSA9IGNvcmUuYXBpXG4gKiBgYGBcbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQVBJIHtcbiAgICAvKipcbiAgICAgKiBWSyBBUEkgdG9rZW4uXG4gICAgICovXG4gICAgcHJpdmF0ZSB2a1Rva2VuOiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBTdGF0cyBvYmplY3QuXG4gICAgICovXG4gICAgcHJpdmF0ZSBzdGF0czogU3RhdHM7XG5cbiAgICAvKipcbiAgICAgKiBRdWV1ZSBvZiBzY2hlZHVsZWQgQVBJIGNhbGxzLlxuICAgICAqL1xuICAgIHByaXZhdGUgcXVldWU6IHtcbiAgICAgICAgbWV0aG9kOiBzdHJpbmc7XG4gICAgICAgIHBhcmFtczogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfTtcbiAgICAgICAgcmVzb2x2ZTogRnVuY3Rpb247XG4gICAgICAgIHJlamVjdDogRnVuY3Rpb247XG4gICAgfVtdID0gW107XG5cbiAgICAvKipcbiAgICAgKiBJcyB0aGUgcXVldWUgYmVpbmcgcHJvY2Vzc2VkIG5vdz9cbiAgICAgKi9cbiAgICBwcml2YXRlIGlzUXVldWVQcm9jZXNzaW5nOiBib29sZWFuID0gZmFsc2U7XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGVzIGEgbmV3IFtbQVBJXV0uXG4gICAgICogQHBhcmFtIHZrVG9rZW4gVksgQVBJIHRva2VuXG4gICAgICogQHBhcmFtIHN0YXRzIFtbU3RhdHNdXSBvYmplY3RcbiAgICAgKi9cbiAgICBwdWJsaWMgY29uc3RydWN0b3IodmtUb2tlbjogc3RyaW5nLCBzdGF0czogU3RhdHMpIHtcbiAgICAgICAgdGhpcy52a1Rva2VuID0gdmtUb2tlbjtcbiAgICAgICAgdGhpcy5zdGF0cyA9IHN0YXRzO1xuXG4gICAgICAgIC8vIENoZWNrIHBlcm1pc3Npb25zXG4gICAgICAgIHRoaXMuY2hlY2tQZXJtaXNzaW9ucygpXG4gICAgICAgICAgICAudGhlbigoZSk6IHZvaWQgPT4ge1xuICAgICAgICAgICAgICAgIGxvZygpXG4gICAgICAgICAgICAgICAgICAgIC5pKGUpXG4gICAgICAgICAgICAgICAgICAgIC5mcm9tKCdhcGknKVxuICAgICAgICAgICAgICAgICAgICAubm93KCk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLmNhdGNoKChlKTogdm9pZCA9PiB7XG4gICAgICAgICAgICAgICAgbG9nKClcbiAgICAgICAgICAgICAgICAgICAgLncoZSlcbiAgICAgICAgICAgICAgICAgICAgLmZyb20oJ2FwaScpXG4gICAgICAgICAgICAgICAgICAgIC5ub3coKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIC8vIFN0YXJ0IHRoZSBxdWV1ZSBwcm9jZXNzaW5nXG4gICAgICAgIHNldEludGVydmFsKCgpOiB2b2lkID0+IHtcbiAgICAgICAgICAgIGlmICghdGhpcy5pc1F1ZXVlUHJvY2Vzc2luZykge1xuICAgICAgICAgICAgICAgIHRoaXMuaXNRdWV1ZVByb2Nlc3NpbmcgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHRoaXMucHJvY2Vzc1F1ZXVlKClcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oKCk6IHZvaWQgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pc1F1ZXVlUHJvY2Vzc2luZyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAuY2F0Y2goKGUpOiB2b2lkID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvZygpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLncoZSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZnJvbSgnYXBpJylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAubm93KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmlzUXVldWVQcm9jZXNzaW5nID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LCAxMDAwKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTY2hlZHVsZXMgYSBjYWxsIHRvIGEgVksgQVBJIE1ldGhvZC5cbiAgICAgKlxuICAgICAqIEFmdGVyIHRoZSBjYWxsIGNvbXBsZXRlcywgYSBjaGVjayB3aWxsIGJlIHBlcmZvcm1lZCB0byBzZWUgaWYgdGhlIGNhbGwgd2FzIHN1Y2Nlc3NmdWwgb3Igbm90LFxuICAgICAqIGFuZCBpbiB0aGUgbGF0dGVyIGNhc2UgYSB3YXJuaW5nIHdpbGwgYmUgbG9nZ2VkLlxuICAgICAqXG4gICAgICogQHBhcmFtIG1ldGhvZCBWSyBBUEkgbWV0aG9kIG5hbWVcbiAgICAgKiBAcGFyYW0gcGFyYW1zIHBhcmFtZXRlcnMgZm9yIHRoZSBtZXRob2QsIGBhY2Nlc3NfdG9rZW5gIGFuZCBgdmAgd2lsbCBiZSBhZGRlZCBhdXRvbWF0aWNhbGx5XG4gICAgICpcbiAgICAgKiBAcmV0dXJuIHByb21pc2UsIHdoaWNoIHJlc29sdmVzIHdpdGggYGpzb24ucmVzcG9uc2VgIHdoZW4gdGhlIHJlcXVlc3QgaXMgY29tcGxldGVkXG4gICAgICogYW5kIGEgcmVzcG9uc2UgaXMgZ2l2ZW4sIGFuZCByZWplY3RzIGlmIGFuIGVycm9yIGhhcHBlbmVkXG4gICAgICpcbiAgICAgKiBAZXhhbXBsZVxuICAgICAqIGBgYFxuICAgICAqIGNvcmUuY21kKCdpbmZvJywgYXN5bmMgJCA9PiB7XG4gICAgICogICAgdmFyIHVpZCA9ICQub2JqLmZyb21faWQ7XG4gICAgICpcbiAgICAgKiAgICAvLyBDYWxsIFZLIEFQSSB0byBnZXQgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHVzZXJcbiAgICAgKiAgICB2YXIgcmVzcG9uc2UgPSBhd2FpdCAkLmFwaS5zY2hlZHVsZUNhbGwoJ3VzZXJzLmdldCcsIHsgdXNlcl9pZHM6IHVpZCB9KTtcbiAgICAgKiAgICB2YXIgdXNlckluZm8gPSByZXNwb25zZVswXTtcbiAgICAgKlxuICAgICAqICAgIHZhciBuYW1lID0gdXNlckluZm8uZmlyc3RfbmFtZTtcbiAgICAgKiAgICB2YXIgc3VybmFtZSA9IHVzZXJJbmZvLmxhc3RfbmFtZTtcbiAgICAgKlxuICAgICAqICAkLnRleHQoYFVzZXIgSUQ6ICR7dWlkfVxcbk5hbWU6ICR7bmFtZX0gJHtzdXJuYW1lfWApO1xuICAgICAqIH0pO1xuICAgICAqIGBgYFxuICAgICAqL1xuICAgIHB1YmxpYyBhc3luYyBzY2hlZHVsZUNhbGwobWV0aG9kOiBzdHJpbmcsIHBhcmFtczogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfSk6IFByb21pc2U8YW55PiB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCk6IHZvaWQgPT4ge1xuICAgICAgICAgICAgdGhpcy5xdWV1ZS5wdXNoKHtcbiAgICAgICAgICAgICAgICBtZXRob2QsXG4gICAgICAgICAgICAgICAgcGFyYW1zLFxuICAgICAgICAgICAgICAgIHJlc29sdmUsXG4gICAgICAgICAgICAgICAgcmVqZWN0LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENhbGwgYSBWSyBBUEkgTWV0aG9kLlxuICAgICAqXG4gICAgICogKipJdCBpcyBoaWdobHkgcmVjb21tZW5kZWQgdG8gdXNlIFtbc2NoZWR1bGVDYWxsXV1cbiAgICAgKiBpbnN0ZWFkIHRvIG5vdCBleGNlZWQgdGhlIEFQSSBxdW90YSBhbmQgdG8gY2hlY2sgd2hldGhlciB0aGUgY2FsbCB3YXMgc3VjY2Vzc2Z1bCBvciBub3QhKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSBtZXRob2QgVksgQVBJIG1ldGhvZCBuYW1lXG4gICAgICogQHBhcmFtIHBhcmFtcyBwYXJhbWV0ZXJzIGZvciB0aGUgbWV0aG9kLCBgYWNjZXNzX3Rva2VuYCBhbmQgYHZgIHdpbGwgYmUgYWRkZWQgYXV0b21hdGljYWxseVxuICAgICAqXG4gICAgICogQGV4YW1wbGVcbiAgICAgKiBgYGBcbiAgICAgKiBjb3JlLmNtZCgnaW5mbycsIGFzeW5jICQgPT4ge1xuICAgICAqICAgIHZhciB1aWQgPSAkLm9iai5mcm9tX2lkO1xuICAgICAqXG4gICAgICogICAgLy8gQ2FsbCBWSyBBUEkgdG8gZ2V0IGluZm9ybWF0aW9uIGFib3V0IHRoZSB1c2VyXG4gICAgICogICAgdmFyIGpzb24gPSBhd2FpdCAkLmFwaS5jYWxsKCd1c2Vycy5nZXQnLCB7IHVzZXJfaWRzOiB1aWQgfSk7XG4gICAgICogICAgdmFyIHVzZXJJbmZvID0ganNvbi5yZXNwb25zZVswXTtcbiAgICAgKlxuICAgICAqICAgIHZhciBuYW1lID0gdXNlckluZm8uZmlyc3RfbmFtZTtcbiAgICAgKiAgICB2YXIgc3VybmFtZSA9IHVzZXJJbmZvLmxhc3RfbmFtZTtcbiAgICAgKlxuICAgICAqICAkLnRleHQoYFVzZXIgSUQ6ICR7dWlkfVxcbk5hbWU6ICR7bmFtZX0gJHtzdXJuYW1lfWApO1xuICAgICAqIH0pO1xuICAgICAqIGBgYFxuICAgICAqL1xuICAgIHB1YmxpYyBhc3luYyBjYWxsKFxuICAgICAgICBtZXRob2Q6IHN0cmluZyxcbiAgICAgICAgcGFyYW1zOiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9LFxuICAgICk6IFByb21pc2U8YW55PiB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICAgICAgICBjb25zdCB1cmwgPSBgaHR0cHM6Ly9hcGkudmsuY29tL21ldGhvZC8ke2VuY29kZVVSSUNvbXBvbmVudChtZXRob2QpfWA7XG5cbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgICAgICAgIHVyaTogdXJsLFxuICAgICAgICAgICAganNvbjogdHJ1ZSxcbiAgICAgICAgICAgIHFzOiB7XG4gICAgICAgICAgICAgICAgYWNjZXNzX3Rva2VuOiB0aGlzLnZrVG9rZW4sIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L2NhbWVsY2FzZVxuICAgICAgICAgICAgICAgIHY6IEFQSV9WRVJTSU9OLFxuICAgICAgICAgICAgICAgIC4uLnBhcmFtcyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3QgcHJvbWlzZSA9IHJlcXVlc3Qob3B0aW9ucyk7XG5cbiAgICAgICAgcHJvbWlzZS5jYXRjaCgoZXJyOiBFcnJvcik6IHZvaWQgPT4ge1xuICAgICAgICAgICAgbG9nKClcbiAgICAgICAgICAgICAgICAudyhgRXJyb3Igb2NjdXJlZCB3aGlsZSBjYWxsaW5nIEFQSSBtZXRob2QgJyR7bWV0aG9kfSc6ICR7ZXJyfWApXG4gICAgICAgICAgICAgICAgLmZyb20oJ2FwaScpXG4gICAgICAgICAgICAgICAgLm5vdygpO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gcHJvbWlzZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTZW5kcyBhIG1lc3NhZ2UgdG8gYSB1c2VyIHZpYSBQZWVyIElELlxuICAgICAqXG4gICAgICogKipOb3RlIHRoYXQgaXQgaXMgbXVjaCBlYXNpZXIgdG8gdXNlIHRoZSBbW0NvbnRleHRdXSBvYmplY3QgcGFzc2VkIHRvIGhhbmRsZXJzXG4gICAgICogdG8gY29tcG9zZSBhbmQgc2VuZCBtZXNzYWdlcywga2V5Ym9hcmRzIGFuZCBhdHRhY2htZW50cyEqKlxuICAgICAqXG4gICAgICogQHBhcmFtIHBpZCBwZWVyIElEXG4gICAgICogQHBhcmFtIG1lc3NhZ2UgbWVzc2FnZSB0ZXh0ICoqKHJlcXVpcmVkLCBpZiBhdHRhY2htZW50IGlzIGVtcHR5KSoqXG4gICAgICogQHBhcmFtIGF0dGFjaG1lbnQgbGlzdCBvZiBhdHRhY2htZW50cywgY29tbWEtc2VwYXJhdGVkXG4gICAgICogKHNlZSBbVksgQVBJIERvY3NdKGh0dHBzOi8vdmsuY29tL2Rldi9tZXNzYWdlcy5zZW5kKSBmb3IgZnVydGhlciBpbmZvcm1hdGlvbilcbiAgICAgKiAqKihyZXF1aXJlZCBpZiBtZXNzYWdlIGlzIGVtcHR5KSoqXG4gICAgICogQHBhcmFtIGtleWJvYXJkIGpzb24gb2Yga2V5Ym9hcmRcbiAgICAgKlxuICAgICAqIEBleGFtcGxlXG4gICAgICogYGBgXG4gICAgICogYXdhaXQgYXBpLnNlbmQoMSwgJ0hlbGxvIScsICdwaG90bzY0OTJfNDU2MjQwNzc4JylcbiAgICAgKiBgYGBcbiAgICAgKi9cbiAgICBwdWJsaWMgYXN5bmMgc2VuZChcbiAgICAgICAgcGlkOiBzdHJpbmcgfCBudW1iZXIsXG4gICAgICAgIG1lc3NhZ2U6IHN0cmluZyxcbiAgICAgICAgYXR0YWNobWVudDogc3RyaW5nLFxuICAgICAgICBrZXlib2FyZDogc3RyaW5nLFxuICAgICk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICAvKiBnbG9iYWwgQmlnSW50ICovXG5cbiAgICAgICAgY29uc3QgcGFyYW1zOiB7XG4gICAgICAgICAgICBwZWVyX2lkOiBzdHJpbmc7XG4gICAgICAgICAgICBtZXNzYWdlPzogc3RyaW5nO1xuICAgICAgICAgICAgYXR0YWNobWVudD86IHN0cmluZztcbiAgICAgICAgICAgIGtleWJvYXJkPzogc3RyaW5nO1xuICAgICAgICAgICAgcmFuZG9tX2lkOiBzdHJpbmc7XG4gICAgICAgIH0gPSB7XG4gICAgICAgICAgICBwZWVyX2lkOiBwaWQudG9TdHJpbmcoKSwgLy8gZXNsaW50LWRpc2FibGUtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvY2FtZWxjYXNlXG4gICAgICAgICAgICByYW5kb21faWQ6IEJpZ0ludC5hc0ludE4oIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L2NhbWVsY2FzZVxuICAgICAgICAgICAgICAgIDMyLFxuICAgICAgICAgICAgICAgIEJpZ0ludChgMHgke2NyeXB0by5yYW5kb21CeXRlcyg2KS50b1N0cmluZygnaGV4Jyl9YCksXG4gICAgICAgICAgICApLnRvU3RyaW5nKCksXG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKG1lc3NhZ2UpIHtcbiAgICAgICAgICAgIHBhcmFtcy5tZXNzYWdlID0gbWVzc2FnZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoYXR0YWNobWVudCkge1xuICAgICAgICAgICAgcGFyYW1zLmF0dGFjaG1lbnQgPSBhdHRhY2htZW50O1xuICAgICAgICB9XG4gICAgICAgIGlmIChrZXlib2FyZCkge1xuICAgICAgICAgICAgcGFyYW1zLmtleWJvYXJkID0ga2V5Ym9hcmQ7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpOiB2b2lkID0+IHtcbiAgICAgICAgICAgIHRoaXMuc2NoZWR1bGVDYWxsKCdtZXNzYWdlcy5zZW5kJywgcGFyYW1zKVxuICAgICAgICAgICAgICAgIC50aGVuKCgpOiB2b2lkID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0cy5zZW50KCk7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5jYXRjaCgoZSk6IHZvaWQgPT4ge1xuICAgICAgICAgICAgICAgICAgICBsb2coKVxuICAgICAgICAgICAgICAgICAgICAgICAgLncoZSlcbiAgICAgICAgICAgICAgICAgICAgICAgIC5mcm9tKCdhcGknKVxuICAgICAgICAgICAgICAgICAgICAgICAgLm5vdygpO1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrcyBpZiB0aGUgcmVxdWlyZWQgcGVybWlzc2lvbnMgZm9yIGJvdCB0byB3b3JrIHByb3Blcmx5IGFyZSBwcmVzZW50LFxuICAgICAqIGFuZCBlbWl0cyBhIHdhcm5pbmcgaWYgdGhhdCBpcyBub3QgdGhlIGNhc2UuXG4gICAgICovXG4gICAgcHJpdmF0ZSBhc3luYyBjaGVja1Blcm1pc3Npb25zKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgICAgIC8vIENoZWNrIGlmIHRoZSB0b2tlbiBoYXMgdGhlIHJlcXVpcmVkIHBlcm1pc3Npb25zXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5zY2hlZHVsZUNhbGwoJ2dyb3Vwcy5nZXRUb2tlblBlcm1pc3Npb25zJywge30pO1xuXG4gICAgICAgIGNvbnN0IHsgcGVybWlzc2lvbnMgfSA9IHJlc3BvbnNlO1xuXG4gICAgICAgIGxldCBvayA9IGZhbHNlO1xuICAgICAgICBwZXJtaXNzaW9ucy5mb3JFYWNoKChwZXJtaXNzaW9uOiBhbnkpOiB2b2lkID0+IHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gICAgICAgICAgICBpZiAocGVybWlzc2lvbi5uYW1lID09PSAnbWVzc2FnZXMnKSB7XG4gICAgICAgICAgICAgICAgb2sgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoIW9rKSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoXG4gICAgICAgICAgICAgICAgbmV3IEVycm9yKFxuICAgICAgICAgICAgICAgICAgICAnVG9rZW4gcGVybWlzc2lvbiBgbWVzc2FnZXNgIGlzIG1pc3NpbmcuIEJvdCB3aWxsIGJlIHVuYWJsZSB0byBzZW5kIGFueSBtZXNzYWdlcycsXG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgnVG9rZW4gcGVybWlzc2lvbiBgbWVzc2FnZXNgIGlzIHByZXNlbnQnKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBNb3ZlIGZvcndhcmQgdGhyb3VnaCB0aGUgcXVldWUsIHByb2Nlc3NpbmcgYXQgbW9zdCBbW0FQSV9RVU9UQV1dIGl0ZW1zXG4gICAgICovXG4gICAgcHJpdmF0ZSBhc3luYyBwcm9jZXNzUXVldWUoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGlmICh0aGlzLnF1ZXVlKSB7XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8PSBBUElfUVVPVEE7IGkgKz0gMSkge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLnF1ZXVlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBjb25zdCBlID0gdGhpcy5xdWV1ZS5zaGlmdCgpO1xuXG4gICAgICAgICAgICAgICAgLyogZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWF3YWl0LWluLWxvb3AgKi9cbiAgICAgICAgICAgICAgICBjb25zdCBqc29uID0gYXdhaXQgdGhpcy5jYWxsKGUubWV0aG9kLCBlLnBhcmFtcyk7XG5cbiAgICAgICAgICAgICAgICBpZiAoanNvbi5yZXNwb25zZSAhPT0gdW5kZWZpbmVkICYmIGpzb24ucmVzcG9uc2UgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgZS5yZXNvbHZlKGpzb24ucmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoanNvbi5lcnJvcikge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBlcnJvckNvZGUgPSBqc29uLmVycm9yLmVycm9yX2NvZGU7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yTXNnID0ganNvbi5lcnJvci5lcnJvcl9tc2c7XG5cbiAgICAgICAgICAgICAgICAgICAgZS5yZWplY3QoXG4gICAgICAgICAgICAgICAgICAgICAgICBgQW4gQVBJIGNhbGwgdG8gbWV0aG9kICcke2UubWV0aG9kfScgZmFpbGVkIGR1ZSB0byBhbiBBUEkgZXJyb3IgIyR7ZXJyb3JDb2RlfTogJHtlcnJvck1zZ31gLFxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGUucmVqZWN0KFxuICAgICAgICAgICAgICAgICAgICAgICAgYEFuIEFQSSBjYWxsIHRvIG1ldGhvZCAnJHtlLm1ldGhvZH0nIGZhaWxlZCBkdWUgdG8gYW4gdW5rbm93biBBUEkgZXJyb3IuIFRoZSBBUEkgcmVzcG9uZGVkIHdpdGg6ICR7SlNPTi5zdHJpbmdpZnkoanNvbil9YCxcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJ05vIHF1ZXVlIGZvciBBUEkgY2FsbHMgZm91bmQnKSk7XG4gICAgfVxufVxuIl19
